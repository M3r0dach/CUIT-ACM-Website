{% extends "admin/base.html" %}
{%- block head -%}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='markdown/css/bootstrap-markdown.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='AdminLTE2/plugins/bootstrap-switch/bootstrap-switch.min.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-tagsinput/bootstrap-tagsinput.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='AdminLTE2/plugins/iCheck/square/blue.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-fileinput/css/fileinput.min.css') }}"/>
{%- endblock -%}
{% block content %}
<div class="box box-primary">
  <div class="box-header with-border">
    <h3 class="box-title"><i class="fa fa-newspaper-o"></i> {{ action }}</h3>
  </div>
  <form id="postForm" method="post"  class="form-horizontal">
    <div class="box-body">
      {{ news_form.hidden_tag() }}
      {{ news_form.sid(style="display:none") }}
      <div class="form-group">
        <label class="control-label col-sm-2" for="inputTitle">新闻标题</label>
        <div class="col-sm-6">
          {{ news_form.title(class="form-control required",id="inputTitle", placeholder="在此填入标题") }}
        </div>
        <div class="col-sm-3">{{ news_form.is_top() }}</div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="inputUrl">固定链接</label>
        <div class="col-sm-9">
          {{ news_form.url(class="form-control required",id="inputUrl", placeholder="固定链接URL") }}
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="inputTag">标签</label>
        <div class="col-sm-9">
          {{ news_form.tags(class='form-control required', id="inputTag" ) }}
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="inputShortcut">摘要</label>
        <div class="col-sm-9">
          {{ news_form.shortcut(class=' required',id="inputShortcut", rows="6", style="resize:none;padding:10px;" , placeholder="摘要") }}
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="inputContent">正文</label>
        <div class="col-sm-9">
          {{ news_form.content(class='required', id="inputContent" , rows="25", style="resize:none;padding:10px;" , placeholder="正文") }}
        </div>
      </div>
      <div class="alert alert-danger  col-sm-offset-2 col-sm-9"  id="post-info" style="display: none;">
          <button type="button" class="close">&times;</button>
          <span id="post-info-text"></span>
      </div>
    </div>
    <div class="box-footer text-center">
      <div class="btn-group">
        <button type="button" class="btn btn-primary" id="save-post">{{ my_button[0] }}</button>
        {{ news_form.submit(class='btn btn-danger', value=my_button[1]) }}
       </div>
    </div>
  </form>
</div>
<div class="modal fade" id="myModal" style="margin-top: 50px;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body no-padding">
        <div class="nav-tabs-custom">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#tab_1" data-toggle="tab">选择图片</a></li>
            <li><a href="#tab_2" data-toggle="tab">上传图片</a></li>
            <li class="pull-right"><a href="#" data-dismiss="modal"><i class="fa fa-times"></i></a></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="tab_1">
              <table class="table table-bordered table-hover table-striped list-table">
                <thead>
                <tr>
                  <th>选择</th><th>名称</th><th>描述</th><th>大小</th><th>上传用户</th><th>权限用途</th><th>上传时间</th>
                </tr>
                </thead>
                <tbody class="list-table-body">
                </tbody>
                <tfoot>
                <tr>
                  <th>选择</th><th>名称</th><th>描述</th><th>大小</th><th>上传用户</th><th>权限用途</th><th>上传时间</th>
                </tr>
                </tfoot>
              </table>
              <div style="text-align: right">
                <button type="button" class="btn btn-danger btn-flat" id="insert_resource">确定</button>
                <button type="button" class="closeModal btn btn-default btn-flat" data-dismiss="modal">取消</button>
              </div>
            </div>
            <div class="tab-pane" id="tab_2">
              <form id="postImg" method="post" class="form-horizontal">
                {{ upload_form.hidden_tag() }}
                <div class="form-group">
                    <label class="control-label col-sm-2" for="inputName"><span class="required-star">* </span>名称</label>
                    <div class="col-sm-9">
                      {{ upload_form.name(class="form-control required",id="inputName", placeholder="名称") }}
                    </div>
                  </div>
                <div class="form-group">
                    <label class="control-label col-sm-2" for="inputShortcut">简介</label>
                    <div class="col-sm-9">
                      {{ upload_form.description(class='form-control required',id="inputdescription", rows="6", style="resize:none;" , placeholder="简介") }}
                    </div>
                  </div>
                <div class="form-group">
                  <label class="control-label col-sm-2" for="inputShortcut"><span class="required-star">* </span>选择文件</label>
                  <div class="col-sm-9">
                    {{ upload_form.upload(id="inputFile") }}
                  </div>
                </div>
                <div class="form-group sr-only">
                  <label class="control-label col-sm-2"><span class="required-star">* </span>权限</label>
                  <div class="col-sm-9">
                    {%- for sub in upload_form.level %}
                      <label class="radio-inline">
                        {{ sub }}
                        {{ sub.label(style='margin-left:10px;') }}
                      </label>
                    {%- endfor %}
                  </div>
                </div>
                <div class="form-group sr-only">
                  <label class="control-label col-sm-2"><span class="required-star">* </span>用途</label>
                  <div class="col-sm-9">
                      {%- for sub in upload_form.usage %}
                        <label class="radio-inline">
                          {{ sub }}
                          {{ sub.label(style='margin-left:10px;') }}
                        </label>
                      {%- endfor %}
                  </div>
                </div>
                <div class="form-group">
                  <div class="alert alert-danger col-sm-offset-2 col-sm-9" id="post-img" style="display: none;">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                    <span id="post-img-text">xxxx</span>
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-sm-offset-2 col-sm-9">
                    {{ upload_form.submit(class='btn btn-primary', value='上传') }}
                    <button type="button" class="closeModal btn btn-default btn-flat" data-dismiss="modal">取消</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{%- block script -%}
<script src="{{ url_for('static', filename='markdown/js/markdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='markdown/js/bootstrap-markdown.js') }}"></script>
<script src="{{ url_for('static', filename='AdminLTE2/plugins/bootstrap-switch/bootstrap-switch.min.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap-tagsinput/bootstrap-tagsinput.min.js') }}"></script>
<script src="{{ url_for('static', filename='AdminLTE2/plugins/iCheck/icheck.min.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap-fileinput/js/fileinput.min.js') }}"></script>
<script>
  function make_iCheck() {
    $('.radio-inline input[type="checkbox"], .radio-inline input[type="radio"]').iCheck({
      checkboxClass: 'icheckbox_square-blue',
      radioClass: 'iradio_square-blue'
    });
    $('.list-table-body input[type="checkbox"], input[type="radio"]').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        radioClass: 'iradio_square-blue'
      });
  }
    function get_resource_list(offset, limit) {
      var data = {offset: offset, limit: limit};
      $.post("{{ url_for('ajax.get_resource_list') }}", data).success(function (ret) {
        var news_count = ret.sum;
        var start = ret.offset;
        var length = ret.limit;
        var news_list = ret.news_list;
        var $list_table = $('.list-table-body').first();
        $list_table.empty();
        if (length == 0) {
          $list_table.append('<tr><td colspan="7"><h2>无资源</h2></tr>');
        } else {
          for (var i = 0; i < length; ++i) {
            $list_table.append(news_list[i]);
          }
        }
        make_iCheck();
        var prev = $('.prev-page');
        var next = $('.next-page');
        if (start == 0) {
          prev.hide();
        } else {
          prev.show();
          prev.val(start - limit);
        }
        if (news_count == start + length) {
          next.hide();
        } else {
          next.show();
          next.val(start + length);
        }
      }).error(function () {
        var $list_table = $('.list-table-body').first();
        $list_table.empty();
        $list_table.append('<tr><td colspan="7"><h2>加载失败</h2></tr>');
        make_iCheck();
        $('.prev-page').hide();
        $('.next-page').hide();
      });
    }
  function makeBootstrapSwitch() {
    $.fn.bootstrapSwitch.defaults.onColor = 'primary';
    $.fn.bootstrapSwitch.defaults.offColor = 'default';
    $.fn.bootstrapSwitch.defaults.onText = '置顶';
    $.fn.bootstrapSwitch.defaults.offText = '取消置顶';
    $("input[type='checkbox']").bootstrapSwitch();
  }
  function makeTagsInput() {
    $('input[id="inputTag"]').tagsinput({
      tagClass: function(item) {
        var label = [
          'label label-primary',
          'label label-danger',
          'label label-success',
          'label label-warning',
          'label label-info',
          'label bg-purple',
          'label bg-orange',
          'label bg-maroon'
        ];
        return label[parseInt(Math.random() *  8, 10)];
      },
      trimValue: true
    });
  }
  function save_post(is_draft) {
    var title = $('#inputTitle');
    if (requiredCheck(title, '文章标题')) {
      if (is_draft) {
        url = "{{ url_for('ajax.post_news', draft='1') }}";
      } else {
        url = "{{ url_for('ajax.post_news', draft='0') }}";
      }
      $.post(url, $('#postForm').serialize()).success(
          function (data) {
            $("#post-info-text").html(data);
            $("#post-info").hide().fadeIn(200);
          }
      );
    }
  }
  $(document).ready(function () {
    make_iCheck();
    makeBootstrapSwitch();
      get_resource_list(0,15);
    makeTagsInput();
    $("#inputFile").fileinput({
      'showUpload': false,
      'allowedFileTypes': ['image'],
      'maxFileSize': 8192,
      'maxFileCount': 1
    });
    $("button.close").click(function () {
      $(".alert").slideUp();
    });
    var md_shortcut = $('#inputShortcut').markdown({iconlibrary: 'fa',
    });
    var md_input_content = $('#inputContent').markdown({iconlibrary: 'fa'});
    $('.md-editor').on("click",".btn[title='Preview']", function(){
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    });
    $('#save-post').click(function(){
        save_post(true);
    });
    $('#postForm').submit(function () {
        save_post(false);
        return false;
    });
    $('#insert_resource').click(function(){
        var $check = $('input[name="resource"]:checked');
        if ($check.length <= 0) {
          return false;
        }
        else {
            var resource_id = $check.val();
            alert(this.getAttribute('data-target'));

        }
    });
    $('#postImg').submit(function () {
      var data = new FormData($('#postImg')[0]);
      var file = $("#inputFile")[0];
      data.append(file.name, file.files[0]);
      $.ajax({
        url: "{{ url_for('ajax.upload') }}",
        type: "POST",
        data: data,
        processData: false,  // 告诉jQuery不要去处理发送的数据
        contentType: false,   // 告诉jQuery不要去设置Content-Type请求头
        success: function (msg) {
          if (msg != 'ok') {
            $("#post-img-text").html(msg);
            $("#post-img").hide().fadeIn(200);
          } else {
            $('.nav-tabs a:first').tab('show');
          }
        }
      });
      return false;
    });
  });
</script>
{%- endblock -%}